name: Setup XFCE Runner + Tailscale + VNC + EduMail Bot

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  setup-gui-runner:
    runs-on: ubuntu-latest
    env:
      TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
      USERNAME: runner
      PASSWORD: runner
      TAILSCALE_HOSTNAME: gh-xfce-vnc-${{ github.run_id }}

    steps:
      - uses: actions/checkout@v4

      - name: Ensure runner user has sudo
        run: |
          echo "${USERNAME}:${PASSWORD}" | sudo chpasswd
          echo "${USERNAME} ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/${USERNAME}

      - name: Install XFCE + VNC server
        run: |
          echo ">>> Installing XFCE Desktop + VNC..."
          sudo apt-get update -qq
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq \
            xfce4 xfce4-terminal dbus-x11 xorg \
            tigervnc-standalone-server tigervnc-common tigervnc-tools

          mkdir -p /home/${USERNAME}/.vnc
          echo ${PASSWORD} | vncpasswd -f > /home/${USERNAME}/.vnc/passwd
          chmod 600 /home/${USERNAME}/.vnc/passwd
          chown -R ${USERNAME}:${USERNAME} /home/${USERNAME}/.vnc

          echo "startxfce4" > /home/${USERNAME}/.xsession
          chown ${USERNAME}:${USERNAME} /home/${USERNAME}/.xsession

      - name: Install Tailscale
        run: |
          echo ">>> Installing Tailscale..."
          curl -fsSL https://tailscale.com/install.sh | sudo sh
          sudo tailscale up --authkey "${TAILSCALE_AUTHKEY}" --hostname "${TAILSCALE_HOSTNAME}"

      - name: Clone edu-mail-auto-generator repo
        run: |
          echo ">>> Cloning edu-mail-auto-generator..."
          git clone https://github.com/kmille36/edu-mail-auto-generator.git /home/${USERNAME}/edu-mail-auto-generator
          chown -R ${USERNAME}:${USERNAME} /home/${USERNAME}/edu-mail-auto-generator

      - name: Install Python + Dependencies
        run: |
          echo ">>> Installing Python & dependencies..."
          sudo apt-get install -y python3 python3-pip
          pip3 install --upgrade pip
          pip3 install selenium

          # Optional: install Chrome + chromedriver (if needed)
          sudo apt-get install -y wget unzip
          wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt install -y ./google-chrome-stable_current_amd64.deb

          CHROME_VERSION=$(google-chrome --version | grep -oP '\d+\.\d+\.\d+\.\d+')
          DRIVER_VERSION=$(curl -s "https://chromedriver.storage.googleapis.com/LATEST_RELEASE")
          wget https://chromedriver.storage.googleapis.com/${DRIVER_VERSION}/chromedriver_linux64.zip
          unzip chromedriver_linux64.zip
          sudo mv chromedriver /usr/local/bin/
          sudo chmod +x /usr/local/bin/chromedriver

      - name: Start VNC + Show Tailscale Info
        run: |
          echo ">>> Starting VNC server..."
          sudo -u ${USERNAME} vncserver :1 -geometry 1280x800 -depth 24 -localhost no

          TAILSCALE_IP=$(tailscale ip -4 | head -n1)

          echo "=== CONNECTION INFO ==="
          echo "USERNAME: ${USERNAME}"
          echo "PASSWORD: ${PASSWORD}"
          echo "Connect with any VNC client to:"
          echo "    ${TAILSCALE_IP}:5901"
          echo
          echo ">>> Project is ready. You can now run the bot manually inside VNC."
          tail -f /dev/null
